<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ECE 4&#x2F;599: The Challenges of BTRFS implementation and getting persistent memory</title>

  <link href="https://khale.github.io/mem-systems-w25/main.css" rel="stylesheet">
  <link rel="alternate" type="application/rss+xml" href="https://khale.github.io/mem-systems-w25/rss.xml">
  <link rel="icon" href="https://khale.github.io/mem-systems-w25/img/favicon.ico">
  <link rel="apple-touch-icon-precomposed" href="https://khale.github.io/mem-systems-w25/img/favicon152.png">
  
<meta name="twitter:card" content="summary">
<meta property="og:type" content="article">
<meta property="og:title" content="The Challenges of BTRFS implementation and getting persistent memory">
<meta property="og:description"
    content="Introduction
This project focused on exploring the benefits and challenges of the BTRFS file system and how it relates to persistent memory. BTRFS is a Merkle-Tree or B-Tree file system designed with CoW in mind. BTRFS is a type of harddrive type or file structure type characterized by its support of snapshotting and its built-in CoW functions. BTRFS dynamically organizes its data dynamically unlike other file systems that use bitmaps and inode tables. BTRFS also includes failsafes like checksums to recover metadata of files in the case that data gets corrupted.">


</head>
<body >
  <header>
    <nav>
      <h1>
          <a href="https://khale.github.io/mem-systems-w25">ECE 4&#x2F;599</a>
      </h1>
      
      
      
      <p><a href="https://khale.github.io/mem-systems-w25/extra-reading/">
        Extra Resources
      </a></p>
      
      
      
      <p><a href="https://khale.github.io/mem-systems-w25/schedule/">
        Schedule
      </a></p>
      
      
      
      <p><a href="https://khale.github.io/mem-systems-w25/project-ideas/">
        Project Ideas
      </a></p>
      
      
      
      <p><a href="https://khale.github.io/mem-systems-w25/syllabus/">
        Syllabus
      </a></p>
      
      
      
      <p><a href="https:&#x2F;&#x2F;khale.github.io&#x2F;mem-systems-w25&#x2F;lesson&#x2F;">
        Lessons
      </a></p>
      
      <p><a href="https://github.com/khale/mem-systems-w25/discussions">Discussions</a></p>
      
      
      <p><a href="https:&#x2F;&#x2F;khale.github.io&#x2F;mem-systems-w25&#x2F;blog&#x2F;">
        Blog
      </a></p>
    </nav>
  </header>
  <main>
    


<h1>
    <a href="https:&#x2F;&#x2F;khale.github.io&#x2F;mem-systems-w25&#x2F;blog&#x2F;">
    The ECE 4&#x2F;599 Course Blog
    </a>
</h1>
<article>
  <h1>The Challenges of BTRFS implementation and getting persistent memory</h1>
  <p class="details">
    
      <span class="author"> by
      
        Benjamin Knutson,
      
        Shuyi Zheng
      
      <span>
    
    <time datetime="2025-03-12">
      March 12, 2025
    </time>
  </p>
  <h2 id="introduction">Introduction</h2>
<p>This project focused on exploring the benefits and challenges of the BTRFS file system and how it relates to persistent memory. BTRFS is a Merkle-Tree or B-Tree file system designed with CoW in mind. BTRFS is a type of harddrive type or file structure type characterized by its support of snapshotting and its built-in CoW functions. BTRFS dynamically organizes its data dynamically unlike other file systems that use bitmaps and inode tables. BTRFS also includes failsafes like checksums to recover metadata of files in the case that data gets corrupted.</p>
<p><img src="https://khale.github.io/mem-systems-w25/blog/btrfs/fins5.png" alt="Example of BTRFS Snapshots" /></p>
<h2 id="table-of-contents">Table of Contents</h2>
<p>BTRFS - binary-tree file system. A file system that has properties including COW (copy on Writing) and snapshot.<br />
Persistent memory - A new type of memory device that has high performance and is byte-addressable.<br />
CoW - Copy on Write<br />
PMEM - Persistent Memory</p>
<h2 id="implementation">Implementation:</h2>
<p>To start it will be assumed that you are installing this filesystem on ubuntu 22.04 through WSL2</p>
<p><img src="https://khale.github.io/mem-systems-w25/blog/btrfs/fin1.png" alt="fig1" />
Figure 1: Setting up a 5GB Disk</p>
<p>You can use a command like <code>sudo mount -o loop,subvol=data btrfs-test.img /mnt/btrfs_test</code> to mount your test image you created. My test image is <code>btrfs-test.img</code> and im mounting <code>/mnt/btrfs_test</code></p>
<p><img src="https://khale.github.io/mem-systems-w25/blog/btrfs/fin2.png" alt="fig2" />
Figure 2: checking that our drive is type btrfs</p>
<p><img src="https://khale.github.io/mem-systems-w25/blog/btrfs/fin3.png" alt="fig3" />
Figure 3: creating a sub volume</p>
<p><img src="https://khale.github.io/mem-systems-w25/blog/btrfs/fin4.png" alt="fig4" />
Figure 4: create a snapshot of a subdirectory</p>
<p>Example initialization of a BTRFS drive:</p>
<p>Create a virtual image<br />
<code>dd if=/dev/zero of=btrfs-test.img bs=1M count=1024</code><br />
Format the system<br />
<code>mkfs.btrfs btrfs-test.img</code>
Create a mount<br />
<code>mkdir -p /mnt/btrfs_test</code>
Set the mount<br />
<code>sudo mount -o loop btrfs-test.img /mnt/btrfs_test</code>
Confirm with: <code>df -Th | grep btrfs</code><br />
Create subvolume<br />
<code>sudo btrfs subvolume create /mnt/btrfs_test/data</code></p>
<h2 id="persistent-memory">Persistent memory</h2>
<p>What is persistent memory?   Persistent memory is a newish type of memory that
serves as a sudo hard disk but in the form of ram. Officially it’s a solid
state high performance byte addressable memory device that resides on the
memory bus of a system, but in layman’s terms it simply stores memory in a non
volatile manner unlike your typical DRAM. This means that it essentially
combines the properties of DRAM and an SSD which gives several advantages like
quicker memory accesses than SSD’s and byte addressable storage.</p>
<p>BTRFS can be used on persistent memory computers, however btrfs is designed
with block devices in mind meaning that for a non block device like PMEM a new
file system would need to be developed for btrfs which would be possible thanks
to PMEMs byte-addressability. BPFS comes to mind as an example of such
a project, although they created a new system rather than adapting btrfs.</p>
<p>##Tests<br />
Our tests focused on the snapshot capabilities of the btrfs file system to get
a better understanding of their capabilities and their applications. Due to
poor planning we were not able to get access to a computer with persistent
memory so we will instead be showing several tests performed on a standard
BTRFS file system using very normal specs (Intel I7-5500U, 8gb DDR4 RAM). The
environment for this experiment was WSL2 running ubuntu 24.04</p>
<ol>
<li>snapshots frequency vs time to take a snapshot</li>
<li>snapshot with vs without noisy programs</li>
<li>snapshot performance over slow change of file</li>
</ol>
<p><img src="https://khale.github.io/mem-systems-w25/blog/btrfs/fin6.png" alt="noise" />
BTRFS noise experiment</p>
<h2 id="results">Results</h2>
<p><img src="https://khale.github.io/mem-systems-w25/blog/btrfs/data_change_plot.png" alt="fig6" />
Figure 6: Random data change plot</p>
<p><img src="https://khale.github.io/mem-systems-w25/blog/btrfs/frequency_plot.png" alt="fig7" />
Figure 7: Frequency of snapshots vs time</p>
<p><img src="https://khale.github.io/mem-systems-w25/blog/btrfs/noise_comparison.png" alt="fig8" />
Figure 8: Snapshotting with and without background processes</p>
<p>Looking at our results we see what we are expecting to see, as we increase our
workload we see a decrease in snapshotting speed. Snapshots of bigger files
take longer, although this is not really visible on the data change graph that
we provided since the range of snapshots did not include large enough sizes.
Snapshots of smaller files (5 GB or lower)</p>
<h2 id="challenges">Challenges</h2>
<p>We faced many challenges trying to study this file system and work with it, as
it turns out however our greatest challenge was finding a machine with
persistent memory hardware. We could have used Amazon web services however we
did not register for them quickly enough so it became unrealistic to work with
them. We were also not able to find a computer lab on campus with an available
persistent memory computer, therefore we were left with testing BTRFS on
a standard computer running a VM.   Both of us were not knowledgeable in
regards to BTRFS really so getting familiar with navigating all the commands
needed for this project was a far greater undertaking than we understood at
first. We also needed help with designing the tests for the file system and we
needed to ask for advice from our professor multiple times. The only other
major setbacks that challenged us was that our testing environment would crash
occasionally causing tasks to take longer than needed.</p>
<h2 id="references">References</h2>
<ul>
<li>Blog about BTRFS and WSL2(<a href="https://blog.bryanroessler.com/2020-12-14-btrfs-on-wsl2/#:~:text=Since%20BTRFS%20is%20baked%20into,is%20still%20a%20preview%20build">https://blog.bryanroessler.com/2020-12-14-btrfs-on-wsl2/#:~:text=Since%20BTRFS%20is%20baked%20into,is%20still%20a%20preview%20build</a>. )</li>
<li>Reading on BPFS a file system developed for persistent memory(<a href="https://dl.acm.org/doi/abs/10.1145/1629575.1629589">https://dl.acm.org/doi/abs/10.1145/1629575.1629589</a> )</li>
<li>BTRFS wikipedia for initial understanding and reference search(<a href="https://en.wikipedia.org/wiki/Btrfs">https://en.wikipedia.org/wiki/Btrfs</a> )</li>
<li>BTRFS commands website(<a href="https://docs.oracle.com/en/operating-systems/oracle-linux/6/admin/ol_use_case3_btrfs.html">https://docs.oracle.com/en/operating-systems/oracle-linux/6/admin/ol_use_case3_btrfs.html</a> )</li>
<li>BTRFS Blog with useful pictures(<a href="https://recoverit.wondershare.com/file-system/what-is-btrfs-file-system.html">https://recoverit.wondershare.com/file-system/what-is-btrfs-file-system.html</a> )</li>
</ul>
<p>Closes #25</p>

  <footer>
    
    <p>The expectation of this project and the result of this project differ quite a lot from each other, that being said we hope you still enjoy this discussion and learn something new from it.</p>

    
    <p>This is the course blog for ECE 4/599, a research-focused course on memory systems in the School of EECS at Oregon State.
You can subscribe to <a href="https://github.com/khale/mem-systems-w25/blog">posts on the blog</a> with <a href="https://github.com/khale/mem-systems-w25/rss.xml">RSS</a>.</p>

  </footer>
</article>

  </main>
  <footer>
    <p><a href="https://www.oregonstate.edu">Oregon State University</a>
    &mdash;
    <a href="https://engineering.oregonstate.edu/EECS">School of EECS</a></p>
  </footer>
</body>
</html>
